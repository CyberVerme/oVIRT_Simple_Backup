var sb_completedtasks=0;var sb_newdiskcreateprogress=0;var sb_completedtasks=[];var sb_currenttask="";var sb_alerttext="";var sb_xen_migrate_progress=0;var sb_restore_area=0;var sb_newsnapshot=0;var sb_imaging_numberofdisks=0;var formwatchsomethingChanged=false;$(window).bind("beforeunload",function(a){if(formwatchsomethingChanged){return true}a=null});function sb_update_statusbox(b,a){if(a.toLowerCase().indexOf("complete")!=-1){formwatchsomethingChanged=false;$("#"+b).html("("+a+")")}else{$("#"+b).html('<i class="fa fa-refresh fa-spin" style="font-size:14px; margin-right: 10px;"></i> '+a);formwatchsomethingChanged=true}}function sb_check_snapshot(a){var b={};b.comm="snapshot_status";b.vmuuid=a;$.ajax({type:"GET",url:"index.php",data:b,dataType:"json",success:function(c){sb_newsnapshot=0;if(c.status==0||c.status==-1){sb_check_snapshot_progress(a);sb_update_statusbox("backupstatus","Creating Snapshot")}else{$("#snapshotbar .progressbarinner").html("Snapshot 100% (COMPLETED)").css("width","100%");sb_update_statusbox("backupstatus","Snapshot Created");sb_create_backup_directories()}}})}function sb_check_snapshot_progress(b,a){$("#snapshotbar").css("display","block");if(a==0){sb_completedtasks=10}sb_completedtasks++;sb_check_snapshot(b);if(sb_completedtasks<=100){$("#snapshotbar .progressbarinner").html("Snapshot "+sb_completedtasks+"%").css("width",sb_completedtasks+"%")}else{$("#snapshotbar .progressbarinner").html("Snapshot 100% (WAITING)")}}function sb_create_backup_directories(){sb_update_statusbox("backupstatus","Creating Backup Directories");var a={};a.comm="backup_create_path";$.ajax({type:"GET",url:"index.php",data:a,dataType:"json",success:function(b){if(b.status==1){sb_update_statusbox("backupstatus","Backup Directories Created");sb_snapshot_attach()}else{sb_update_statusbox("backupstatus","Failed: "+b.reason)}}})}function sb_snapshot_attach(){sb_update_statusbox("backupstatus","Attaching Snapshot To Backup Appliance For Imaging");var a={};a.comm="backup_attach_image";$.ajax({type:"GET",url:"index.php",data:a,dataType:"json",success:function(b){if(b.status==1){sb_update_statusbox("backupstatus","Snapshot Attached");sb_snapshot_imaging()}else{sb_update_statusbox("backupstatus","Failed: "+b.reason)}}})}function sb_snapshot_imaging(){sb_update_statusbox("backupstatus","Imaging Disk(s)");$("#imagingbar").css("display","block");var a={};a.comm="backup_imaging";$.ajax({type:"GET",url:"index.php",data:a,dataType:"json",success:function(b){if(b.status==1){sb_update_statusbox("backupstatus","Imaging Started - Disk "+b.thisdisk);sb_snapshot_imaging()}else{if(b.status==2){sb_update_statusbox("backupstatus","Imaging In Progress - Disk "+b.thisdisk);$("#imagingbar .progressbarinner").html("Imaging "+b.progress+"% - Disk "+ +b.thisdisk).css("width",b.progress+"%");sb_snapshot_imaging()}else{if(b.status==3){sb_update_statusbox("backupstatus","Imaging Complete - Disk "+b.thisdisk);sb_snapshot_detatch()}else{sb_update_statusbox("backupstatus","Failed: "+b.reason)}}}}})}function sb_snapshot_detatch(){sb_update_statusbox("backupstatus","Detaching Snapshot From Backup Appliance");var a={};a.comm="backup_detatch_image";$.ajax({type:"GET",url:"index.php",data:a,dataType:"json",success:function(b){if(b.status==1){sb_update_statusbox("backupstatus","Snapshot Detached");sb_snapshot_delete()}else{sb_update_statusbox("backupstatus","Failed: "+b.reason)}}})}function sb_snapshot_delete(){sb_update_statusbox("backupstatus","Detaching Snapshot From Backup Appliance");var a={};a.comm="snapshot_delete";$.ajax({type:"GET",url:"index.php",data:a,dataType:"json",success:function(b){if(b.status==1){sb_update_statusbox("backupstatus","Backup Completed");alert("Backup Completed!")}else{sb_update_statusbox("backupstatus","Failed: "+b.reason)}}})}function checkRestoreNow(c){var b=$("#restorenewname").val();var a=b.replace(/[0-9a-zA-Z\-_]/g,"");if(b==""){alert("You must enter a New VM Name to restore this image to.")}else{if(a!=""){alert("You must enter a New VM Name that does not contain anything other than a-zA-Z0-9-_")}else{if(c==1){if(confirm("Restore this VM Now?")){$(".gobutton").css("display","none");sb_check_disk_progress(b)}}else{$(".gobutton").css("display","none");sb_check_disk_progress(b)}}}}function sb_restore_disk_create(){var e=$("#restorenewname").val();var f=$("#vmuuid").val();var m=$("#vmname").val();var b=$("#buname").val();var d=$("#option_fixgrub").val();var q=$("#option_fixswap").val();var j="";if(d==1){j=j+"fixgrub"}if(q==1){j=j+"fixswap"}var c=$("#os").val();var l=$("#console").val();var i=$("#memory").val();var g=$("#memory_max").val();var a=$("#nic1").val();var n=$("#sockets").val();var k=$("#cores").val();var h=$("#threads").val();var o=$("#cluster").val();var s=$("#domain").val();var r=$("#vmtype").val();var p={};p.comm="restore_disk_create";p.newvmname=e;p.vmuuid=f;p.vmname=m;p.buname=b;p.fixestext=j;p.os=c;p.console=l;p.memory=i;p.memory_max=g;p.nic1=a;p.cpu_sockets=n;p.cpu_cores=k;p.cpu_threads=h;p.cluster=o;p.domain=s;p.vmtype=r;$.ajax({type:"GET",url:"index.php",data:p,dataType:"json",success:function(t){sb_newdiskcreateprogress+=5;if(t.status==0){sb_update_statusbox("restorestatus","Failed - "+t.reason);$("#creatediskstatus").html("").css("display","none")}else{if(t.status==1){sb_check_disk_progress();sb_update_statusbox("restorestatus","Creating Disk(s)")}else{if(t.status==2){sb_check_disk_progress();sb_update_statusbox("restorestatus","Waiting for Disk(s)")}else{if(t.status==3){$("#creatediskstatus .progressbarinner").html("Disk Create (COMPLETED)").css("width","100%");sb_update_statusbox("restorestatus","Disk(s) Ready");sb_restore_imaging()}}}}}})}function sb_check_disk_progress(a,b,c){$("#creatediskstatus").css("display","block");if(c==0){sb_newdiskcreateprogress=0}sb_restore_disk_create();if(sb_newdiskcreateprogress<=100){$("#creatediskstatus .progressbarinner").html("Creating Disk(s) "+sb_newdiskcreateprogress+"%").css("width",sb_newdiskcreateprogress+"%")}else{$("#creatediskstatus .progressbarinner").html("Creating Disk(s) 100% (WAITING)")}}function sb_restore_imaging(){sb_update_statusbox("restorestatus","Imaging Disk(s)");$("#imagingbar").css("display","block");var a={};a.comm="restore_imaging";$.ajax({type:"GET",url:"index.php",data:a,dataType:"json",success:function(b){if(b.status==1){sb_imaging_numberofdisks=b.numberofdisks;sb_update_statusbox("restorestatus","Imaging Started - Disk "+b.thisdisk);sb_restore_imaging()}else{if(b.status==2){sb_update_statusbox("restorestatus","Imaging In Progress - Disk "+b.thisdisk);if(b.progress==0){$("#imagingbar .progressbarinner").html("Imaging "+b.progress+"% ").css("width",b.progress+"%")}else{$("#imagingbar .progressbarinner").html("Imaging "+b.progress+"% - Disk "+b.thisdisk).css("width",b.progress+"%")}sb_restore_imaging()}else{if(b.status==3){if(b.numberofimages==b.thisdisk){sb_update_statusbox("restorestatus","Imaging Complete - All Disks")}else{sb_update_statusbox("restorestatus","Imaging Complete - Disk "+b.thisdisk)}sb_restore_run_options()}else{sb_update_statusbox("restorestatus","Failed: "+b.reason)}}}}})}function sb_restore_run_options(){var d=0;if(sb_currenttask==""){sb_update_statusbox("restorestatus","Checking Additional Tasks Selected");d=1}var c=$("#option_fixgrub").val();var b=$("#option_fixswap").val();if(typeof sb_completedtasks.fix_grub!=="undefined"){c=0}if(typeof sb_completedtasks.fix_swap!=="undefined"){b=0}var a=0;if(c==1){a=1;sb_currenttask="fix_grub"}else{if(b==1){a=1;sb_currenttask="fix_swap"}}if(a==0&&sb_currenttask==""){sb_update_statusbox("restorestatus","All Optional Tasks Completed");sb_vm_create()}else{if(a==1){var e={};e.comm=sb_currenttask;$.ajax({type:"GET",url:"index.php",data:e,dataType:"json",success:function(f){if(f.status==0){sb_restore_run_options()}else{if(f.status==1){sb_update_statusbox("restorestatus","Running: "+sb_currenttask+" Please Wait...");sb_restore_run_options()}else{if(f.status==2){sb_update_statusbox("restorestatus","Completed: "+sb_currenttask+"");sb_completedtasks[sb_currenttask]=1;if(sb_currenttask=="fix_swap"){sb_alerttext+="\n\nSwap Repair Configured. \n\nYou will have to run:\n\n/root/fixswap1.sh *will auto restart*\n\n/root/fixswap2.sh\n\non the new VM once you start it."}sb_currenttask="";sb_restore_run_options()}}}}})}}}function sb_vm_create(){var a={};a.comm="restore_vm_create";$.ajax({type:"GET",url:"index.php",data:a,dataType:"json",success:function(b){if(b.status==0){sb_update_statusbox("restorestatus","Failed - "+b.reason)}else{if(b.status==1){sb_update_statusbox("restorestatus","VM Created");sb_disk_detatch()}}}})}function sb_disk_detatch(b,a){var c={};c.comm="disk_detatch";$.ajax({type:"GET",url:"index.php",data:c,dataType:"json",success:function(d){if(d.status==0){sb_update_statusbox("restorestatus","Failed - "+d.reason)}else{if(d.status==1){sb_update_statusbox("restorestatus","Disk Detatched");setTimeout(sb_disk_attach(),3000);sb_update_statusbox("restorestatus","VM Restore Completed");setTimeout(alert("The VM should now be restored, You will have to manually confirm the memory, NICs, CPUs etc to make sure all is as required."+sb_alerttext),5000)}}}})}function sb_disk_attach(){var a={};a.comm="disk_attach";$.ajax({type:"GET",url:"index.php",data:a,dataType:"json",success:function(b){if(b.status==0){sb_update_statusbox("restorestatus","Failed - "+b.reason)}else{if(b.status==1){if(sb_restore_area==0){sb_update_statusbox("restorestatus","Disk Attached Completed")}else{sb_update_statusbox("restorestatus","Disk Attached & VM Completed")}}}}})}function sb_vm_option(a,b,d){var c={};c.comm="vm_update_settings";c.vmuuid=a;c.option=b;c.ovalue=d;$.ajax({type:"GET",url:"index.php",data:c,dataType:"json",success:function(e){if(e.status==0){sb_update_statusbox("restorestatus","Failed - "+e.reason)}else{if(e.status==1){sb_update_statusbox("restorestatus","Option "+b+" Set to "+d)}}}})}function sb_migrateXenStart(){var c=$("#restorenewname").val();var a=$("#disksize").val();var b=c.replace(/[0-9a-zA-Z\-_]/g,"");if(c==""){alert("You must enter a New VM Name to restore this image to.")}else{if(b!=""){alert("You must enter a New VM Name that does not contain anything other than a-zA-Z0-9-_")}else{if(confirm("Make sure you understand this will shutdown the original VM on Xen as listed in the Migration Process.\n\nMigrate this VM Now?")){$(".gobutton").css("display","none");sb_xen_start_migrate()}}}}function sb_xen_start_migrate(){sb_xen_migrate_progress=1;sb_xen_shutdown(0)}function sb_xen_shutdown(a){if(sb_xen_migrate_progress==1){var c=$("#xenuuid").val();var b="Xen VM"}else{var c="-migrate-";var b="Xen BackupVM"}sb_update_statusbox("restorestatus","Shutting Down "+b);$("#xenbar").css("display","block");var d={};d.comm="xen_shutdown";d.xenuuid=c;$.ajax({type:"GET",url:"index.php",data:d,dataType:"json",success:function(e){if(e.status==1){sb_update_statusbox("restorestatus",b+" Shutting Down");$("#xenbar .progressbarinner").html("Shutting Down 25%").css("width","25%");sb_xen_shutdown(1)}else{if(e.status==2){sb_update_statusbox("restorestatus",b+" Shutting Down - Waiting");$("#xenbar .progressbarinner").html("Shutting Down 50%").css("width","50%");sb_xen_shutdown(1)}else{if(e.status==3){sb_update_statusbox("restorestatus",b+" Shutdown - Completed");$("#xenbar .progressbarinner").html("Shutting Down 100%").css("width","100%");if(sb_xen_migrate_progress==1){sb_xen_removedisk(0)}else{if(sb_xen_migrate_progress==2){sb_xen_attachdisk(0)}else{if(sb_xen_migrate_progress==3){sb_xen_removedisk(0)}}}}else{sb_update_statusbox("restorestatus","Failed: "+e.reason)}}}}})}function sb_xen_removedisk(a){if(sb_xen_migrate_progress<3){sb_xen_migrate_progress=2}$("#xenbar .progressbarinner").html("").css("width","0%");sb_update_statusbox("restorestatus","Disconnecting Disk from VM");$("#xenbar").css("display","block");var b={};b.comm="xen_remove_vbd";$.ajax({type:"GET",url:"index.php",data:b,dataType:"json",success:function(c){if(c.status==1){sb_update_statusbox("restorestatus","Xen VM Removing Disk(s)");$("#xenbar .progressbarinner").html("Removing Disk 25%").css("width","25%");sb_xen_removedisk(1)}else{if(c.status==2){sb_update_statusbox("restorestatus","Xen VM Removing Disk - Waiting");$("#xenbar .progressbarinner").html("Removing Disk 50%").css("width","50%");sb_xen_removedisk(1)}else{if(c.status==3){sb_update_statusbox("restorestatus","Xen VM Disk Removed");$("#xenbar .progressbarinner").html("Removing Disk 100%").css("width","100%");if(sb_xen_migrate_progress<3){sb_xen_shutdown(0)}else{sb_xen_attachdisk(0)}}else{sb_update_statusbox("restorestatus","Failed: "+c.reason);sb_xen_removedisk(1)}}}}})}function sb_xen_attachdisk(a){$("#xenbar .progressbarinner").html("").css("width","0%");if(sb_xen_migrate_progress<3){sb_update_statusbox("restorestatus","Attaching Disk to BackupVM on Xen")}else{sb_update_statusbox("restorestatus","Re-Attaching Disk to VM on Xen")}$("#xenbar").css("display","block");var b={};b.comm="xen_add_vbd";$.ajax({type:"GET",url:"index.php",data:b,dataType:"json",success:function(c){if(c.status==1){sb_update_statusbox("restorestatus","Xen VM Attaching Disk(s)");$("#xenbar .progressbarinner").html("Attaching Disk 25%").css("width","25%");sb_xen_attachdisk(1)}else{if(c.status==2){sb_update_statusbox("restorestatus","Xen VM Attaching Disk - Waiting");$("#xenbar .progressbarinner").html("Attaching Disk 50%").css("width","50%");sb_xen_attachdisk(1)}else{if(c.status==3){sb_update_statusbox("restorestatus","Xen VM Disk Attached");$("#xenbar .progressbarinner").html("Attaching Disk 100%").css("width","100%");if(sb_xen_migrate_progress<3){sb_xen_startup(0)}else{var d=$("#option_restartxenyn").val();if(d==1){sb_xen_startup(0)}else{sb_xen_launch_restore()}}}else{sb_update_statusbox("restorestatus","Failed: "+c.reason)}}}}})}function sb_xen_startup(a){if(sb_xen_migrate_progress==2){var c="-migrate-";var b="Xen BackupVM"}else{var c=$("#xenuuid").val();var b="Xen VM"}sb_update_statusbox("restorestatus","Starting "+b);$("#xenbar").css("display","block");var d={};d.comm="xen_start";d.xenuuid=c;d.xstatus=a;$.ajax({type:"GET",url:"index.php",data:d,dataType:"json",success:function(e){if(e.status==1){sb_update_statusbox("restorestatus",b+" Starting");$("#xenbar .progressbarinner").html("Starting 25%").css("width","25%");sb_xen_startup(1)}else{if(e.status==2){sb_update_statusbox("restorestatus",b+" Shutting Down - Waiting");$("#xenbar .progressbarinner").html("Starting 50%").css("width","50%");sb_xen_startup(1)}else{if(e.status==3){sb_update_statusbox("restorestatus",b+" Starting - Completed");$("#xenbar .progressbarinner").html("Starting 100%").css("width","100%");if(sb_xen_migrate_progress==2){sb_xen_imagedisk(0)}else{if(sb_xen_migrate_progress==3){sb_xen_launch_restore()}}}else{sb_update_statusbox("restorestatus","Failed: "+e.reason)}}}}})}function sb_xen_imagedisk(){sb_update_statusbox("restorestatus","Imaging Xen Disk(s)");$("#xenimagingbar").css("display","block");var a={};a.comm="xen_imaging";$.ajax({type:"GET",url:"index.php",data:a,dataType:"json",success:function(b){if(b.status==1){sb_imaging_numberofdisks=b.numberofdisks;sb_update_statusbox("restorestatus","Imaging Xen Started - "+sb_imaging_numberofdisks+" Disk(s)");sb_xen_imagedisk()}else{if(b.status==2){sb_update_statusbox("restorestatus","Imaging Xen In Progress - Disk "+b.thisdisk);$("#xenimagingbar .progressbarinner").html("Imaging Xen VM "+b.progress+"% - Disk "+b.thisdisk).css("width",b.progress+"%");sb_xen_imagedisk()}else{if(b.status==3){$("#xenimagingbar .progressbarinner").html("Imaging Xen VM 100% - Disk "+b.thisdisk).css("width","100%");sb_update_statusbox("restorestatus","Imaging Xen Complete - Disk "+b.thisdisk);sb_xen_migrate_progress=3;sb_xen_shutdown(0)}else{sb_update_statusbox("restorestatus","Failed: "+b.reason);sb_xen_imagedisk()}}}}})}function sb_xen_launch_restore(){checkRestoreNow(0)};